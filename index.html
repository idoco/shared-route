<!DOCTYPE html>
<html>
<head>
    <title>SharedRoute</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <style>
        html, body, #map-canvas {
            height: 100%;
            margin: 0;
            padding: 0
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.96.1/css/materialize.min.css">
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&key=AIzaSyDW8g1aWXUVF3ELNbIGpGhXbMYZp7jScVQ"></script>
    <script>
        var wsocket;
        var sessionId = Math.floor((Math.random() * 10000000) + 1);
        var serviceLocation = "ws://sharedroute.cloudapp.net/app";
        var taxiMap = {};
        var taxiIcon;
        var map;

        function initialize() {
			var myLatlng = new google.maps.LatLng(32.078043, 34.774177); // Add the coordinates

            var mapOptions = {
                center: myLatlng,
                zoom: 14, // The initial zoom level when your map loads (0-20)
                minZoom: 13, // Minimum zoom level allowed (0-20)
                maxZoom: 17, // Maximum soom level allowed (0-20)
                zoomControl:true, // Set to true if using zoomControlOptions below, or false to remove all zoom controls.
                zoomControlOptions: {
                    style:google.maps.ZoomControlStyle.DEFAULT // Change to SMALL to force just the + and - buttons.
                },
                mapTypeId: google.maps.MapTypeId.ROADMAP, // Set the type of Map
                scrollwheel: true, // Disable Mouse Scroll zooming (Essential for responsive sites!)
                // All of the below are set to true by default, so simply remove if set to true:
                panControl:false, // Set to false to disable
                mapTypeControl:false, // Disable Map/Satellite switch
                scaleControl:false, // Set to false to hide scale
                streetViewControl:false, // Set to disable to hide street view
                overviewMapControl:false, // Set to false to remove overview control
                rotateControl:false // Set to false to disable rotate control			
            };
            var mapDiv = document.getElementById('map-canvas');
            map = new google.maps.Map(mapDiv, mapOptions);

            taxiIcon = new google.maps.MarkerImage(
                    "https://raw.githubusercontent.com/idoco/shared-route/master/app/SharedRoute/app/src/main/res/drawable-xhdpi/ic_launcher.png",
                    null, null, null, new google.maps.Size(40,40)); // Create a variable for our marker image.

            new google.maps.Marker({ // Set the marker
                position: myLatlng, // Position marker to coordinates
                map: map, // assign the marker to our map variable
                title: 'Incoming Taxi!'
            });

			var ctaLayer = new google.maps.KmlLayer({
				url: 'http://raw.githubusercontent.com/idoco/shared-route/master/map.kml'
			});
			ctaLayer.setMap(map);

            connectToServer();

            // We add a DOM event here to show an alert if the DIV containing the
            // map is clicked. Note that we do this within the intialize function
            // since the document object isn't loaded until after the window.load
            // event.
            // google.maps.event.addDomListener(mapDiv, 'click', showAlert);
        }

        // function showAlert() {
        //  window.alert('DIV clicked');
        //}

        function onMessageReceived(evt) {
            var msg = JSON.parse(evt.data); // native API
            var msgSessionId = msg["sessionId"];
            if (taxiMap[msgSessionId]){
                console.log("In map" + msg.toString());
                var newMarkerLatLng = new google.maps.LatLng(msg["lat"], msg["lng"]);
                var newMarker = taxiMap[msgSessionId];
                newMarker.setPosition(newMarkerLatLng)

            } else {
                console.log("Not in map" + msg.toString());
                var markerLatLng = new google.maps.LatLng(msg["lat"], msg["lng"]);
                taxiMap[msgSessionId] = new google.maps.Marker({ // Set the marker
                    position: markerLatLng, // Position marker to coordinates
                    icon: taxiIcon, //use our image as the marker
                    map: map, // assign the marker to our map variable
                    title: 'Incoming Taxi!'
                });
            }
        }
        function sendMessage(lat, lng) {
            var msg = '{"sessionId":"' + sessionId + '", "lat":"' + lat + '", "lng":"' + lng + '"}';
            wsocket.send(msg);
        }

        function connectToServer() {
            wsocket = new WebSocket(serviceLocation);
            wsocket.onmessage = onMessageReceived;
        }

        function startRide(){
            alert("Button clicked");
        }


        google.maps.event.addDomListener(window, 'load', initialize);
    </script>
</head>
<body>
<a href="https://github.com/idoco/shared-route/">
    <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 999;"
         src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png"
         alt="Fork me on GitHub">
</a>
<div id="map-canvas"></div>
<div class="fixed-action-btn" style="bottom: 45px; right: 25px;">
    <a class="btn-floating btn-large waves-effect waves-light green" onclick="startRide()"><i class="mdi-maps-directions-bus"></i></a>
</div>
</body>
</html>
