<!DOCTYPE html>
<html>
<head>
    <title>SharedRoute</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <style>
        html, body, #map-canvas {
            height: 100%;
            margin: 0;
            padding: 0
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.96.1/css/materialize.min.css">
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&key=AIzaSyDW8g1aWXUVF3ELNbIGpGhXbMYZp7jScVQ"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.96.1/js/materialize.min.js"></script>
    <script>
        var wsocket;
        var sessionId = Math.floor((Math.random() * 10000000) + 1);
        var serviceLocation = "ws://sharedroute.cloudapp.net/app";
        var taxiMap = {};
        var taxiIcon;
        var map;
        var userLocation;
        var userMaker;
        var isSharingLocation = false;

        function initialize() {
            var defaultLatLng = new google.maps.LatLng(32.078043, 34.774177); // Add the coordinates

            var mapOptions = {
                center: defaultLatLng,
                zoom: 14, // The initial zoom level when your map loads (0-20)
                minZoom: 13, // Minimum zoom level allowed (0-20)
                maxZoom: 17, // Maximum soom level allowed (0-20)
                zoomControl:true, // Set to true if using zoomControlOptions below, or false to remove all zoom controls.
                zoomControlOptions: {
                    style:google.maps.ZoomControlStyle.DEFAULT // Change to SMALL to force just the + and - buttons.
                },
                mapTypeId: google.maps.MapTypeId.ROADMAP, // Set the type of Map
                scrollwheel: true, // Disable Mouse Scroll zooming (Essential for responsive sites!)
                // All of the below are set to true by default, so simply remove if set to true:
                panControl:false, // Set to false to disable
                mapTypeControl:false, // Disable Map/Satellite switch
                scaleControl:false, // Set to false to hide scale
                streetViewControl:false, // Set to disable to hide street view
                overviewMapControl:false, // Set to false to remove overview control
                rotateControl:false // Set to false to disable rotate control			
            };
            var mapDiv = document.getElementById('map-canvas');
            map = new google.maps.Map(mapDiv, mapOptions);

            taxiIcon = new google.maps.MarkerImage(
                    "https://raw.githubusercontent.com/idoco/shared-route/master/app/SharedRoute/app/src/main/res/drawable-xhdpi/ic_launcher.png",
                    null, null, null, new google.maps.Size(40,40)); // Create a variable for our marker image.

            userMaker = new google.maps.Marker({ // Set the marker
                position: defaultLatLng, // Position marker to coordinates
                map: map, // assign the marker to our map variable
                title: 'Me!'
            });

            var ctaLayer = new google.maps.KmlLayer({
                url: 'http://raw.githubusercontent.com/idoco/shared-route/master/map.kml'
            });
            ctaLayer.setMap(map);

            connectToServer();
            getLocation();

            google.maps.event.addListenerOnce(map, 'idle', function(){
                $('#loading-spinner').remove();
            });
        }

        function getLocation() {

            function positionSuccess(position) {
                console.log("New user position",position);
                userLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                userMaker.setPosition(userLocation);

                if (isSharingLocation) {
                    sendMessage(userLocation.lat(), userLocation.lng());
                }
            }

            function positionError(err) {
                console.error('ERROR(' + err.code + '): ' + err.message);
            }

            if (navigator.geolocation) {
                var options = {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 3000
                };
                navigator.geolocation.watchPosition(positionSuccess, positionError, options);
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        function onMessageReceived(evt) {
            var msg = JSON.parse(evt.data); // native API
            var msgSessionId = msg["sessionId"];
            if (taxiMap[msgSessionId]){
                console.log("Taxi id "+ msgSessionId + " on map, updating marker location");
                var newMarkerLatLng = new google.maps.LatLng(msg["lat"], msg["lng"]);
                var newMarker = taxiMap[msgSessionId];
                newMarker.setPosition(newMarkerLatLng)

            } else if (msgSessionId != sessionId) {
                console.log("Taxi id "+ msgSessionId + " not on map, adding new marker");
                var markerLatLng = new google.maps.LatLng(msg["lat"], msg["lng"]);
                taxiMap[msgSessionId] = new google.maps.Marker({ // Set the marker
                    position: markerLatLng, // Position marker to coordinates
                    icon: taxiIcon, //use our image as the marker
                    map: map, // assign the marker to our map variable
                    title: 'Incoming Taxi!'
                });
            } else {
                console.log("Taxi id "+ msgSessionId + " is my taxi. Not adding to map");
            }
        }
        function sendMessage(lat, lng) {
            var msg = '{"sessionId":"' + sessionId + '", "lat":"' + lat + '", "lng":"' + lng + '"}';
            wsocket.send(msg);
        }

        function connectToServer() {
            wsocket = new WebSocket(serviceLocation);
            wsocket.onmessage = onMessageReceived;
        }

        function startRide(){
            var button = $("#share-location-button")[0];
            if (!isSharingLocation){
                button.className = "waves-effect waves-light btn red";
                button.innerHTML = "<i class=\"mdi-maps-directions-bus right\"></i> Stop Sharing";
                if (userLocation) {
                    sendMessage(userLocation.lat(), userLocation.lng());
                }
                isSharingLocation = true;

            } else{
                button.className = "waves-effect waves-light btn green";
                button.innerHTML = "<i class=\"mdi-maps-directions-bus right\"></i> Share My Taxi";
                isSharingLocation = false;
            }
        }


        google.maps.event.addDomListener(window, 'load', initialize);
    </script>
</head>
<body>
<a href="https://github.com/idoco/shared-route/">
    <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 100;"
         src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png"
         alt="Fork me on GitHub">
</a>

<div id="loading-spinner" class="valign-wrapper center" style="position:fixed; height: 100%; width: 100%; z-index: 100;">
    <div class="valign" style="width: 100%">
        <div class="preloader-wrapper big active">
            <div class="spinner-layer spinner-blue-only">
                <div class="circle-clipper left">
                    <div class="circle"></div>
                </div>
                <div class="gap-patch">
                    <div class="circle"></div>
                </div>
                <div class="circle-clipper right">
                    <div class="circle"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="map-canvas"></div>

<div class="fixed-action-btn center" style="width: 100%; bottom: 45px;">
    <a id="share-location-button" class="waves-effect waves-light btn green" onclick="startRide()">
        <i class="mdi-maps-directions-bus right"></i>
        Share My Taxi
    </a>
</div>
</body>
</html>
